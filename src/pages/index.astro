---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import CategoryFilter from '../components/command/CategoryFilter.astro';
import CommandList from '../components/command/CommandList.astro';
import CommandDetail from '../components/command/CommandDetail.astro';
import MobileLayout from '../components/layout/MobileLayout.astro';
import { categories, commands } from '../data/generated/commands';

// Estado inicial
const initialCommands = commands;
---

<BaseLayout 
  title="TechSec Cheatsheet - Comandos de Seguridad y Hacking Ético"
  description="Tu guía completa de comandos de seguridad y hacking ético. Documentación actualizada desde Notion con las mejores prácticas para pentesting, CTF y seguridad informática."
>
  <Header />
  
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Layout móvil -->
    <div class="lg:hidden">
      <MobileLayout commands={initialCommands} />
    </div>
    
    <!-- Layout desktop -->
    <div class="hidden lg:flex flex-1 min-h-screen bg-gray-50 dark:bg-gray-900">
      <!-- Categorías - Fijas -->
      <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 p-6 sticky top-0 h-screen overflow-y-auto z-10 shadow-sm">
        <CategoryFilter 
          categories={categories}
          activeCategory="all"
        />
      </aside>

      <!-- Lista de comandos - Fija -->
      <main class="flex-1 p-8 bg-white dark:bg-gray-800 sticky top-0 h-screen overflow-y-auto z-10 shadow-sm">
        <div class="mb-6">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">
            Comandos disponibles
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Mostrando <span id="command-count" class="font-medium">{initialCommands.length}</span> comandos
          </p>
        </div>
        <CommandList 
          commands={initialCommands}
        />
      </main>

      <!-- Detalles del comando -->
      <aside id="command-detail-aside" class="w-1/2 min-w-96 max-w-[60%] p-6 pb-20 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 overflow-hidden relative transform-gpu shadow-sm">
        <!-- Resizer handle -->
        <div id="resizer" class="absolute left-0 top-0 bottom-0 w-1 bg-gray-300 dark:bg-gray-600 cursor-col-resize hover:bg-blue-500 transition-colors"></div>
        
        <CommandDetail command={null} />
      </aside>
    </div>
  </div>

  <Footer />
</BaseLayout>

<script>
import { commands, categories } from '../data/generated/commands';

// Funcionalidad de redimensionamiento del aside (solo desktop)
function initResizer() {
  const aside = document.getElementById('command-detail-aside') as HTMLElement;
  const resizer = document.getElementById('resizer') as HTMLElement;
  
  if (!aside || !resizer) return;
  
  let isResizing = false;
  let startX: number;
  let startWidth: number;
  
  resizer.addEventListener('mousedown', (e) => {
    isResizing = true;
    startX = e.clientX;
    startWidth = aside.offsetWidth;
    
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    
    // Prevenir selección de texto durante el resize
    e.preventDefault();
  });
  
  function handleMouseMove(e: MouseEvent) {
    if (!isResizing || !aside) return;
    
    const deltaX = startX - e.clientX;
    const newWidth = startWidth + deltaX;
    
    // Obtener el ancho total de la ventana
    const windowWidth = window.innerWidth;
    
    // Calcular límites en píxeles basados en porcentajes
    const minWidth = 384; // min-w-96 (384px)
    const maxWidth = windowWidth * 0.6; // 60% del ancho de la ventana
    
    if (newWidth >= minWidth && newWidth <= maxWidth) {
      aside.style.width = `${newWidth}px`;
    }
  }
  
  function handleMouseUp() {
    isResizing = false;
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
  }
}

// Inicializar el resizer cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', initResizer);

// Hacer los comandos disponibles globalmente
(window as any).__CHEATSHEET_COMMANDS__ = JSON.parse(`${JSON.stringify(commands)}`);
</script>
