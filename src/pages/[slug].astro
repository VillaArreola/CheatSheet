---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import { commands } from '../data/generated/commands';

export async function getStaticPaths() {
  return commands.map((command) => {
    // Generar el slug del comando (mismo algoritmo que usa loadCommandDetail)
    const slug = command.title.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
    
    return {
      params: { slug },
      props: { command },
    };
  });
}

const { command } = Astro.props;
const { slug } = Astro.params;

// Funci√≥n para obtener el color de la categor√≠a
function getCategoryColor(category: string): string {
  const colorMap: { [key: string]: string } = {
    'Cifrado': 'purple',
    'dns': 'blue',
    'linux': 'green',
    'security': 'red',
    'network': 'indigo',
    'database': 'purple',
    'web': 'orange',
    'git': 'teal',
    'docker': 'cyan',
    'scan': 'blue',
    'escan': 'blue',
    'python': 'green'
  };
  
  return colorMap[category] || 'gray';
}

const categoryColor = getCategoryColor(command.category);
---

<BaseLayout 
  title={`${command.title} - TechSec Cheatsheet`}
  description={command.description || `Gu√≠a completa del comando ${command.title}`}
>
  <Header />
  
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Header del comando -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 sm:p-8 mb-6">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm">
          <ol class="flex items-center space-x-2 text-gray-600 dark:text-gray-400">
            <li><a href="/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Inicio</a></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-900 dark:text-gray-100 font-medium">{command.title}</li>
          </ol>
        </nav>

        <!-- T√≠tulo y categor√≠a -->
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 mb-6">
          <div class="flex-1">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-gray-100 mb-3 font-mono">
              {command.title}
              {command.dangerous && (
                <span class="inline-block ml-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 text-sm font-bold px-3 py-1 rounded-full">‚ö†Ô∏è Peligroso</span>
              )}
            </h1>
            {command.description && (
              <p class="text-lg text-gray-600 dark:text-gray-400">{command.description}</p>
            )}
          </div>
          <div class="flex-shrink-0">
            <span class={`inline-block px-4 py-2 rounded-full text-sm font-semibold bg-${categoryColor}-100 dark:bg-${categoryColor}-900/30 text-${categoryColor}-700 dark:text-${categoryColor}-400`}>
              {command.category}
            </span>
          </div>
        </div>

        <!-- Sintaxis principal -->
        {command.syntax && (
          <div class="bg-gray-800 dark:bg-gray-900 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Sintaxis</span>
              <button 
                onclick={`navigator.clipboard.writeText('${command.syntax.replace(/'/g, "\\'")}').then(() => { this.textContent = '‚úì Copiado'; setTimeout(() => this.textContent = 'Copiar', 2000); })`}
                class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1 rounded transition-colors"
              >
                Copiar
              </button>
            </div>
            <code class="text-green-400 font-mono text-sm block overflow-x-auto">
              {command.syntax}
            </code>
          </div>
        )}

        <!-- Tags -->
        {command.tags && command.tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {command.tags.map((tag: string) => (
              <span class="inline-block px-3 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>

      <!-- Contenido markdown -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 sm:p-8">
        <div id="markdown-content" class="prose prose-lg max-w-none">
          <div class="flex items-center justify-center py-12">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-200 border-t-blue-600"></div>
            <span class="ml-4 text-gray-600 dark:text-gray-400 font-medium">Cargando contenido...</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <Footer />
</BaseLayout>

<script define:vars={{ slug }}>
// Variable para almacenar marked
let markedLib = null;

// Funci√≥n para cargar marked din√°micamente
async function getMarked() {
  if (!markedLib) {
    try {
      const module = await import('/_astro/marked.esm.C_4XxkkN.js');
      markedLib = module.marked;
      markedLib.setOptions({
        gfm: true,
        breaks: true,
        headerIds: false,
        mangle: false
      });
    } catch (err) {
      console.error('Error loading marked:', err);
      // Fallback: try CDN
      if (!window.marked) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
      }
      markedLib = window.marked;
      markedLib.setOptions({
        gfm: true,
        breaks: true,
        headerIds: false,
        mangle: false
      });
    }
  }
  return markedLib;
}

// Funci√≥n para remover frontmatter de markdown
function removeFrontmatter(content) {
  const lines = content.split('\n');
  let inFrontmatter = false;
  let frontmatterEndIndex = -1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line === '---') {
      if (!inFrontmatter) {
        inFrontmatter = true;
      } else {
        frontmatterEndIndex = i;
        break;
      }
    }
  }
  
  if (frontmatterEndIndex !== -1) {
    return lines.slice(frontmatterEndIndex + 1).join('\n').trim();
  }
  
  return content;
}

// Funci√≥n para aplicar estilos de Tailwind al HTML generado
function applyTailwindStyles(html) {
  return html
    .replace(/<h1[^>]*>(.*?)<\/h1>/g, (match, content) => {
      return `<div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-l-4 border-blue-500 rounded-r-lg p-6 mb-8">
        <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-100 mb-2">${content}</h1>
        <div class="w-24 h-1 bg-blue-500 mx-auto rounded-full"></div>
      </div>`;
    })
    .replace(/<h2[^>]*>.*?üè¥‚Äç‚ò†Ô∏è.*?Ejemplo.*?<\/h2>\s*<pre[^>]*><code[^>]*>([^<]+)<\/code><\/pre>/g, (match, codeContent) => {
      return `<div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-l-4 border-green-500 rounded-r-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">üè¥‚Äç‚ò†Ô∏è Ejemplo</h3>
        <div class="flex items-center space-x-3">
          <div class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-3 font-mono text-sm text-gray-800 dark:text-gray-200 select-all">${codeContent}</div>
          <button onclick="navigator.clipboard.writeText('${codeContent.replace(/'/g, "\\'")}').then(() => { this.innerHTML = '‚úì Copiado!'; setTimeout(() => this.innerHTML = 'üìã Copiar', 2000); })" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2 whitespace-nowrap">
            üìã Copiar
          </button>
        </div>
      </div>`;
    })
    .replace(/<h3[^>]*>.*?Referencias.*?<\/h3>/g, (match) => {
      return `<h3 class="text-xl font-bold text-center text-gray-900 dark:text-gray-100 mt-12 mb-4 bg-gray-800 dark:bg-gray-700 text-white py-3 rounded-lg">üîó Referencias</h3>`;
    })
    .replace(/<(h[2-3])>/g, (match, tag) => {
      const classes = {
        'h2': 'text-xl font-bold mt-8 mb-4 text-gray-900 dark:text-gray-100',
        'h3': 'text-lg font-bold mt-6 mb-3 text-gray-800 dark:text-gray-200'
      };
      return `<${tag} class="${classes[tag]}">`;
    })
    .replace(/<p>/g, '<p class="my-4 leading-relaxed text-gray-700 dark:text-gray-300">')
    .replace(/<pre>/g, '<pre class="bg-gray-800 text-green-400 p-4 rounded-lg my-6 overflow-x-auto text-sm border border-gray-700">')
    .replace(/<code>/g, '<code class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-sm font-mono text-gray-900 dark:text-gray-100">')
    .replace(/<a /g, '<a class="text-blue-600 hover:text-blue-800 hover:underline dark:text-blue-400 dark:hover:text-blue-300" ')
    .replace(/<(ul|ol)>/g, '<$1 class="ml-6 mb-4">')
    .replace(/<li>/g, '<li class="mb-2 text-gray-700 dark:text-gray-300">')
    .replace(/<blockquote>/g, '<blockquote class="border-l-4 border-blue-500 pl-4 my-6 italic text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 py-2 rounded-r">')
    .replace(/<table>/g, '<table class="w-full border-collapse border border-gray-300 dark:border-gray-600 my-6 rounded-lg overflow-hidden">')
    .replace(/<th>/g, '<th class="border border-gray-300 dark:border-gray-600 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-left font-semibold text-gray-900 dark:text-gray-100">')
    .replace(/<td>/g, '<td class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-gray-700 dark:text-gray-300">');
}

// Cargar el contenido markdown
async function loadContent() {
  const markdownContent = document.getElementById('markdown-content');
  
  console.log('üîç Intentando cargar comando:', slug);
  
  try {
    const mdPath = `/comando/${slug}.md`;
    console.log('üìÅ Ruta del archivo:', mdPath);
    
    const response = await fetch(mdPath);
    
    console.log('üì° Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const fileContent = await response.text();
    console.log('üìÑ Archivo cargado, tama√±o:', fileContent.length, 'caracteres');
    
    const cleanMarkdown = removeFrontmatter(fileContent);
    console.log('‚úÇÔ∏è Markdown limpio, tama√±o:', cleanMarkdown.length, 'caracteres');
    
    const markedInstance = await getMarked();
    const rawHtml = markedInstance.parse(cleanMarkdown);
    console.log('üîß HTML generado, tama√±o:', rawHtml.length, 'caracteres');
    
    const htmlContent = applyTailwindStyles(rawHtml);
    console.log('üé® Estilos aplicados');
    
    markdownContent.innerHTML = htmlContent;
    console.log('‚úÖ Contenido renderizado exitosamente');
    
  } catch (error) {
    console.error('‚ùå Error cargando markdown:', error);
    console.error('Stack:', error.stack);
    
    markdownContent.innerHTML = `
      <div class="text-center py-12">
        <div class="text-red-400 dark:text-red-500 mb-4">
          <svg class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <p class="text-red-500 dark:text-red-400 text-sm font-medium">No se pudo cargar el contenido detallado</p>
        <p class="text-gray-400 dark:text-gray-500 text-xs mt-2">Archivo: ${slug}.md</p>
        <p class="text-gray-400 dark:text-gray-500 text-xs mt-1">Error: ${error.message}</p>
      </div>
    `;
  }
}

// Cargar contenido cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', loadContent);
</script>

