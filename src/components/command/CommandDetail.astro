---
import Card from '../ui/Card.astro';
import Badge from '../ui/Badge.astro';

interface Props {
  command?: any;
}

const { command } = Astro.props;
---

<aside class="w-full h-full">
  <!-- Estado inicial -->
  <div id="detail-placeholder" class="text-center py-12">
    <div class="text-gray-300 mb-6">
      <svg class="h-20 w-20 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
    </div>
    <p class="text-gray-500 text-base font-medium">Selecciona un comando para ver los detalles</p>
    <p class="text-gray-400 text-sm mt-2">El contenido completo se mostrar√° aqu√≠</p>
  </div>

  <!-- Contenido del detalle -->
  <div id="detail-content" class="hidden">
    <div class="prose prose-lg max-w-none">
      <div id="markdown-content" class="space-y-4"></div>
    </div>
  </div>
</aside>

<script>
// Importar marked din√°micamente
let marked: any = null;

// Funci√≥n para cargar marked
async function loadMarked() {
  if (!marked) {
    const { marked: markedModule } = await import('marked');
    marked = markedModule;
    
    // Configurar marked para usar clases de Tailwind
    marked.setOptions({
      gfm: true, // GitHub Flavored Markdown
      breaks: true,
      headerIds: false,
      mangle: false
    });
  }
  return marked;
}

// Funci√≥n para remover frontmatter de markdown
function removeFrontmatter(content: string): string {
  const lines = content.split('\n');
  let inFrontmatter = false;
  let frontmatterEndIndex = -1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line === '---') {
      if (!inFrontmatter) {
        inFrontmatter = true;
      } else {
        frontmatterEndIndex = i;
        break;
      }
    }
  }
  
  if (frontmatterEndIndex !== -1) {
    return lines.slice(frontmatterEndIndex + 1).join('\n').trim();
  }
  
  return content;
}

// Funci√≥n para aplicar estilos de Tailwind al HTML generado
function applyTailwindStyles(html: string): string {
  return html
    // Headers
    .replace(/<h1>/g, '<h1 class="text-2xl font-bold mt-10 mb-6 text-gray-900">')
    .replace(/<h2>/g, '<h2 class="text-xl font-bold mt-8 mb-4 text-gray-900">')
    .replace(/<h3>/g, '<h3 class="text-lg font-bold mt-6 mb-3 text-gray-800">')
    
    // P√°rrafos
    .replace(/<p>/g, '<p class="my-4 leading-relaxed text-gray-700">')
    
    // Code blocks
    .replace(/<pre>/g, '<pre class="bg-gray-800 text-green-400 p-4 rounded-lg my-6 overflow-x-auto text-sm">')
    .replace(/<code>/g, '<code class="bg-gray-200 px-2 py-1 rounded text-sm font-mono text-gray-900">')
    
    // Links
    .replace(/<a /g, '<a class="text-blue-600 hover:text-blue-800 hover:underline" ')
    
    // Lists
    .replace(/<ul>/g, '<ul class="ml-6 mb-4">')
    .replace(/<ol>/g, '<ol class="ml-6 mb-4">')
    .replace(/<li>/g, '<li class="mb-2 text-gray-700">')
    
    // Blockquotes
    .replace(/<blockquote>/g, '<blockquote class="border-l-4 border-blue-500 pl-4 my-6 italic text-gray-700 bg-gray-50 py-2">')
    
    // Tables
    .replace(/<table>/g, '<table class="w-full border-collapse border border-gray-300 my-6">')
    .replace(/<th>/g, '<th class="border border-gray-300 px-3 py-2 bg-gray-100 text-left font-semibold text-gray-900">')
    .replace(/<td>/g, '<td class="border border-gray-300 px-3 py-2 text-gray-700">');
}

// Funci√≥n para cargar y mostrar el contenido markdown
async function loadCommandDetail(commandTitle: string) {
  const placeholder = document.getElementById('detail-placeholder');
  const content = document.getElementById('detail-content');
  const markdownContent = document.getElementById('markdown-content');
  
  if (!placeholder || !content || !markdownContent) return;

  try {
    // Generar el nombre del archivo
    const fileName = commandTitle.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
    
    // Hacer fetch del archivo markdown
    const response = await fetch(`/comando/${fileName}.md`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const fileContent = await response.text();
    
    // Remover el frontmatter
    const cleanMarkdown = removeFrontmatter(fileContent);
    
    // Cargar marked y convertir markdown a HTML
    const markedInstance = await loadMarked();
    const rawHtml = markedInstance.parse(cleanMarkdown);
    
    // Aplicar estilos de Tailwind
    const htmlContent = applyTailwindStyles(rawHtml);
    
    // Mostrar el contenido
    markdownContent.innerHTML = htmlContent;
    placeholder.classList.add('hidden');
    content.classList.remove('hidden');
    
    console.log(`‚úÖ Contenido markdown cargado para: ${commandTitle}`);
    
  } catch (error) {
    console.error(`‚ùå Error cargando markdown para ${commandTitle}:`, error);
    
    // Mostrar mensaje de error
    const fileName = commandTitle.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
    markdownContent.innerHTML = `
      <div class="text-center py-8">
        <div class="text-red-400 mb-4">
          <svg class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <p class="text-red-500 text-sm">No se pudo cargar el contenido detallado</p>
        <p class="text-gray-400 text-xs mt-2">Buscando: ${fileName}.md</p>
      </div>
    `;
    placeholder.classList.add('hidden');
    content.classList.remove('hidden');
  }
}

// Funci√≥n para limpiar el detalle
function clearCommandDetail() {
  const placeholder = document.getElementById('detail-placeholder');
  const content = document.getElementById('detail-content');
  
  if (placeholder && content) {
    placeholder.classList.remove('hidden');
    content.classList.add('hidden');
  }
}

// Hacer las funciones globales
(window as any).loadCommandDetail = loadCommandDetail;
(window as any).clearCommandDetail = clearCommandDetail;

// Interceptar la funci√≥n showPreview existente
window.addEventListener('DOMContentLoaded', () => {
  const originalShowPreview = (window as any).showPreview;
  
  if (originalShowPreview) {
    (window as any).showPreview = function(commandId: string) {
      // Llamar a la funci√≥n original
      originalShowPreview(commandId);
      
      // Tambi√©n cargar el detalle markdown
      const commands = (window as any).__CHEATSHEET_COMMANDS__;
      if (commands) {
        const command = commands.find((c: any) => c.id === commandId);
        if (command) {
          console.log('üîç Cargando detalle para:', command.title);
          loadCommandDetail(command.title);
        }
      }
    };
  }
  
  // Tambi√©n interceptar clics directos en las tarjetas de comandos
  document.addEventListener('click', (event) => {
    const target = event.target as HTMLElement;
    const commandCard = target.closest('.command-card');
    
    if (commandCard) {
      const commandTitle = commandCard.querySelector('h3')?.textContent;
      if (commandTitle) {
        console.log('üîç Clic detectado en comando:', commandTitle);
        loadCommandDetail(commandTitle);
      }
    }
  });
});
</script>
