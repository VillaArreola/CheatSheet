---
import Card from '../ui/Card.astro';
import Badge from '../ui/Badge.astro';

interface Props {
  command?: any;
}

const { command } = Astro.props;
---

<aside class="w-full h-full transform-gpu bg-white dark:bg-gray-800">
  <!-- Estado inicial -->
  <div id="detail-placeholder" class="text-center py-12 h-full overflow-y-auto">
    <!-- Header con t√≠tulo -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">TechSec CheatSheet</h2>
      <p class="text-gray-600 dark:text-gray-400">Tu gu√≠a de comandos de seguridad</p>
    </div>

    <!-- Icono principal -->
    <div class="text-blue-500 mb-8">
      <svg class="h-24 w-24 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
      </svg>
    </div>

    <!-- Mensaje principal -->
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-6 mb-8 border border-blue-100 dark:border-blue-800">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-3">¬°Bienvenido!</h3>
      <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed mb-4">
        Selecciona cualquier comando de la lista para ver su documentaci√≥n completa, 
        ejemplos de uso y todos los detalles t√©cnicos.
      </p>
      <div class="flex items-center justify-center space-x-2 text-xs text-blue-600 dark:text-blue-400 bg-blue-100 dark:bg-blue-900/30 rounded-full px-4 py-2 inline-block">
        <span>üí°</span>
        <span>Contenido completo de Notion</span>
      </div>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="grid grid-cols-2 gap-4 mb-8">
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="total-commands">3</div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Comandos</div>
      </div>
      <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 text-center">
        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="total-categories">0</div>
        <div class="text-xs text-gray-600 dark:text-gray-400">Categor√≠as</div>
      </div>
    </div>

    <!-- Tips √∫tiles -->
    <div class="text-left space-y-3">
      <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center">
        <span class="mr-2">üöÄ</span>
        Tips √∫tiles
      </h4>
      <div class="space-y-2 text-xs text-gray-600 dark:text-gray-400">
        <div class="flex items-start space-x-2">
          <span class="text-blue-500 dark:text-blue-400 mt-0.5">‚Ä¢</span>
          <span>Usa los filtros de categor√≠a para encontrar comandos espec√≠ficos</span>
        </div>
        <div class="flex items-start space-x-2">
          <span class="text-blue-500 dark:text-blue-400 mt-0.5">‚Ä¢</span>
          <span>Puedes redimensionar este panel arrastrando el borde izquierdo</span>
        </div>
        <div class="flex items-start space-x-2">
          <span class="text-blue-500 dark:text-blue-400 mt-0.5">‚Ä¢</span>
          <span>El contenido se actualiza autom√°ticamente desde Notion</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenido del detalle -->
  <div id="detail-content" class="hidden relative h-full overflow-y-auto bg-white dark:bg-gray-800">
    <div class="prose prose-lg max-w-none">
      <div id="markdown-content" class="space-y-4 leading-relaxed"></div>
    </div>
  </div>
</aside>

<script>
// Importar marked din√°micamente
let marked: any = null;

// Funci√≥n para cargar marked
async function loadMarked() {
  if (!marked) {
    const { marked: markedModule } = await import('marked');
    marked = markedModule;
    
    // Configurar marked para usar clases de Tailwind
    marked.setOptions({
      gfm: true, // GitHub Flavored Markdown
      breaks: true,
      headerIds: false,
      mangle: false
    });
  }
  return marked;
}

// Funci√≥n para remover frontmatter de markdown
function removeFrontmatter(content: string): string {
  const lines = content.split('\n');
  let inFrontmatter = false;
  let frontmatterEndIndex = -1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line === '---') {
      if (!inFrontmatter) {
        inFrontmatter = true;
      } else {
        frontmatterEndIndex = i;
        break;
      }
    }
  }
  
  if (frontmatterEndIndex !== -1) {
    return lines.slice(frontmatterEndIndex + 1).join('\n').trim();
  }
  
  return content;
}

// Funci√≥n para aplicar estilos de Tailwind al HTML generado (optimizada)
function applyTailwindStyles(html: string): string {
  // Usar una sola expresi√≥n regular para mejor rendimiento
  return html
    .replace(/<h1[^>]*>(.*?)<\/h1>/g, (match, content: string) => {
      return `<div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-l-4 border-blue-500 rounded-r-lg p-6 mb-8">
        <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-gray-100 mb-2">${content}</h1>
        <div class="w-24 h-1 bg-blue-500 mx-auto rounded-full"></div>
      </div>`;
    })
    .replace(/<h2[^>]*>.*?üè¥‚Äç‚ò†Ô∏è.*?Ejemplo.*?<\/h2>\s*<pre[^>]*><code[^>]*>([^<]+)<\/code><\/pre>/g, (match, codeContent) => {
      return `<div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border-l-4 border-green-500 rounded-r-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-3">üè¥‚Äç‚ò†Ô∏è Ejemplo</h3>
        <div class="flex items-center space-x-3">
          <div class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-3 font-mono text-sm text-gray-800 dark:text-gray-200 select-all">${codeContent}</div>
          <button onclick="copyToClipboard(this)" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center space-x-2 whitespace-nowrap">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span>üìã Copiar</span>
          </button>
        </div>
      </div>`;
    })
    .replace(/<h3[^>]*>.*?Referencias.*?<\/h3>/g, (match) => {
      return `<h3 class="text-xl font-bold text-center text-gray-900 dark:text-gray-100 mt-12 mb-4 bg-gray-800 dark:bg-gray-700 text-white py-3 rounded-lg">üîó Referencias</h3>`;
    })
    .replace(/<(h[2-3])>/g, (match, tag: string) => {
      const classes: Record<string, string> = {
        'h2': 'text-xl font-bold mt-8 mb-4 text-gray-900 dark:text-gray-100',
        'h3': 'text-lg font-bold mt-6 mb-3 text-gray-800 dark:text-gray-200'
      };
      return `<${tag} class="${classes[tag]}">`;
    })
    .replace(/<p>/g, '<p class="my-4 leading-relaxed text-gray-700 dark:text-gray-300">')
    .replace(/<pre>/g, '<pre class="bg-gray-800 text-green-400 p-4 rounded-lg my-6 overflow-x-auto text-sm border border-gray-700">')
    .replace(/<code>/g, '<code class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded text-sm font-mono text-gray-900 dark:text-gray-100">')
    .replace(/<a /g, '<a class="text-blue-600 hover:text-blue-800 hover:underline dark:text-blue-400 dark:hover:text-blue-300" ')
    .replace(/<(ul|ol)>/g, '<$1 class="ml-6 mb-4">')
    .replace(/<li>/g, '<li class="mb-2 text-gray-700 dark:text-gray-300">')
    .replace(/<blockquote>/g, '<blockquote class="border-l-4 border-blue-500 pl-4 my-6 italic text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800 py-2 rounded-r">')
    .replace(/<table>/g, '<table class="w-full border-collapse border border-gray-300 dark:border-gray-600 my-6 rounded-lg overflow-hidden">')
    .replace(/<th>/g, '<th class="border border-gray-300 dark:border-gray-600 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-left font-semibold text-gray-900 dark:text-gray-100">')
    .replace(/<td>/g, '<td class="border border-gray-300 dark:border-gray-600 px-3 py-2 text-gray-700 dark:text-gray-300">');
}

// Cache para evitar recargar el mismo contenido
const contentCache = new Map();

// Debounce para evitar m√∫ltiples cargas
let loadingTimeout: number | null = null;
let currentLoadingCommand: string | null = null;

// Funci√≥n para cargar y mostrar el contenido markdown con optimizaciones
async function loadCommandDetail(commandTitle: string) {
  
  // Debounce: cancelar carga anterior si es diferente
  if (loadingTimeout) {
    clearTimeout(loadingTimeout);
  }
  
  // Si ya se est√° cargando el mismo comando, no hacer nada
  if (currentLoadingCommand === commandTitle) {
    return;
  }
  
  currentLoadingCommand = commandTitle;
  
  // Detectar si estamos en m√≥vil o desktop
  const isMobile = window.innerWidth < 1024;
  
  let placeholder, content, markdownContent;
  
  if (isMobile) {
    // En m√≥vil, usar el contenedor m√≥vil del nuevo layout
    const mobileContainer = document.getElementById('mobile-detail-content');
    if (!mobileContainer) return;
    
    // Crear elementos din√°micamente para m√≥vil
    placeholder = null;
    content = mobileContainer;
    markdownContent = mobileContainer;
  } else {
    // En desktop, usar los elementos existentes
    placeholder = document.getElementById('detail-placeholder');
    content = document.getElementById('detail-content');
    markdownContent = document.getElementById('markdown-content');
  }
  
  if (!content || !markdownContent) return;

  // Generar el nombre del archivo
  const fileName = commandTitle.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
  
     // Verificar cache primero
   if (contentCache.has(fileName)) {
     const cachedContent = contentCache.get(fileName);
     markdownContent.innerHTML = cachedContent;
     if (placeholder) placeholder.classList.add('hidden');
     content.classList.remove('hidden');
           currentLoadingCommand = null;
      return;
    }

  try {
    // Mostrar loading state
    markdownContent.innerHTML = `
      <div class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-200 border-t-blue-600"></div>
        <span class="ml-4 text-gray-600 dark:text-gray-400 font-medium">Cargando contenido...</span>
      </div>
    `;
    if (placeholder) placeholder.classList.add('hidden');
    content.classList.remove('hidden');
    
         // Hacer fetch del archivo markdown
     const response = await fetch(`/comando/${fileName}.md`);
     
     if (!response.ok) {
       throw new Error(`HTTP error! status: ${response.status}`);
     }
     
     const fileContent = await response.text();
    
    // Remover el frontmatter
    const cleanMarkdown = removeFrontmatter(fileContent);
    
               // Cargar marked y convertir markdown a HTML
      const markedInstance = await loadMarked();
      const rawHtml = markedInstance.parse(cleanMarkdown);
      
      // Aplicar estilos de Tailwind
      const htmlContent = applyTailwindStyles(rawHtml);
    
    // Guardar en cache
    contentCache.set(fileName, htmlContent);
    
               // Usar requestAnimationFrame para actualizar DOM
      requestAnimationFrame(() => {
        markdownContent.innerHTML = htmlContent;
        currentLoadingCommand = null;
      });
    
  } catch (error) {
    console.error(`‚ùå Error cargando markdown para ${commandTitle}:`, error);
    
    // Mostrar mensaje de error
    markdownContent.innerHTML = `
      <div class="text-center py-12">
        <div class="text-red-400 dark:text-red-500 mb-4">
          <svg class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <p class="text-red-500 dark:text-red-400 text-sm font-medium">No se pudo cargar el contenido detallado</p>
        <p class="text-gray-400 dark:text-gray-500 text-xs mt-2">Buscando: ${fileName}.md</p>
      </div>
    `;
    currentLoadingCommand = null;
  }
}

// Funci√≥n para limpiar el detalle
function clearCommandDetail() {
  const placeholder = document.getElementById('detail-placeholder');
  const content = document.getElementById('detail-content');
  
  if (placeholder && content) {
    placeholder.classList.remove('hidden');
    content.classList.add('hidden');
  }
}

// Funci√≥n para actualizar estad√≠sticas
function updateStats() {
  const commands = (window as any).__CHEATSHEET_COMMANDS__;
  const categories = (window as any).__CHEATSHEET_CATEGORIES__;
  
  if (commands) {
    const totalCommands = document.getElementById('total-commands');
    if (totalCommands) {
      totalCommands.textContent = commands.length.toString();
    }
  }
  
  // Obtener categor√≠as √∫nicas de los comandos
  if (commands) {
    const uniqueCategories = [...new Set(commands.map(cmd => cmd.category))];
    const totalCategories = document.getElementById('total-categories');
    if (totalCategories) {
      totalCategories.textContent = uniqueCategories.length.toString();
    }
  }
}



// Funci√≥n para copiar al portapapeles
function copyToClipboard(button: HTMLElement) {
  const commandContainer = button.closest('div');
  const commandText = commandContainer?.querySelector('.select-all')?.textContent;
  
  if (commandText) {
    navigator.clipboard.writeText(commandText).then(() => {
      // Cambiar el texto del bot√≥n temporalmente
      const buttonText = button.querySelector('span');
      const originalText = buttonText?.textContent || '';
      
      if (buttonText) {
        buttonText.textContent = '¬°Copiado!';
        button.classList.remove('bg-green-500', 'hover:bg-green-600');
        button.classList.add('bg-green-600');
        
        // Restaurar despu√©s de 2 segundos
        setTimeout(() => {
          if (buttonText) buttonText.textContent = originalText;
          button.classList.remove('bg-green-600');
          button.classList.add('bg-green-500', 'hover:bg-green-600');
        }, 2000);
      }
    }).catch(err => {
      console.error('Error al copiar:', err);
    });
  }
}

// Hacer las funciones globales
(window as any).loadCommandDetail = loadCommandDetail;
(window as any).clearCommandDetail = clearCommandDetail;
(window as any).copyToClipboard = copyToClipboard;

// Interceptar la funci√≥n showPreview existente
window.addEventListener('DOMContentLoaded', () => {
  // Actualizar estad√≠sticas al cargar
  updateStats();
  
  const originalShowPreview = (window as any).showPreview;
  
  if (originalShowPreview) {
    (window as any).showPreview = function(commandTitle: string) {
      // Llamar a la funci√≥n original
      originalShowPreview(commandTitle);
      
      // Tambi√©n cargar el detalle markdown
      loadCommandDetail(commandTitle);
    };
  }
  


});
</script>
