---
import CommandCard from './CommandCard.astro';

interface Props {
  commands: any[];
  selectedCommand?: string;
}

const { commands, selectedCommand } = Astro.props;
---

<div id="desktop-command-list-container" class="space-y-6">
  {commands.map((command: any) => (
    <CommandCard
      command={command}
      isSelected={command.id === selectedCommand}
      onClick={`showPreview('${command.title}')`}
    />
  ))}
</div>



<script>
import { commands } from '../../data/generated/commands';

function showPreview(commandTitle: string) {
  // Esta funci칩n ahora solo se usa para desktop
  // En m칩vil se intercepta en MobileLayout
}

// Funci칩n para filtrar comandos por categor칤a
function filterCommandsByCategory(category: string) {
  const container = document.getElementById('desktop-command-list-container');
  if (!container) {
    return;
  }
  
  const allCommands = (window as any).__CHEATSHEET_COMMANDS__ || commands;
  let filteredCommands;
  
  if (category === 'all') {
    filteredCommands = allCommands;
  } else {
    // Mapeo de categor칤as para compatibilidad
    const categoryMap: { [key: string]: string[] } = {
      'scan': ['scan', 'escan', 'dns'],
      'escan': ['escan', 'scan', 'dns'],
      'e-can': ['escan', 'scan', 'dns'],
      'python': ['python'],
      'linux': ['linux'],
      'security': ['security'],
      'network': ['network'],
      'database': ['database'],
      'web': ['web'],
      'git': ['git'],
      'docker': ['docker']
    };
    
    const targetCategories = categoryMap[category.toLowerCase()] || [category.toLowerCase()];
    filteredCommands = allCommands.filter((cmd: any) => {
      return targetCategories.includes(cmd.category.toLowerCase());
    });
  }
  
  // Actualizar contador en el header principal con animaci칩n
  const counter = document.getElementById('command-count');
  if (counter) {
    counter.classList.add('transition-all', 'duration-300');
    counter.textContent = filteredCommands.length.toString();
    counter.classList.add('scale-110', 'text-blue-600', 'dark:text-blue-400');
    setTimeout(() => {
      counter.classList.remove('scale-110', 'text-blue-600', 'dark:text-blue-400');
    }, 300);
  }
  
  // Actualizar el t칤tulo para mostrar la categor칤a activa
  const title = document.querySelector('main h2');
  if (title) {
    if (category === 'all') {
      title.textContent = 'Comandos disponibles';
    } else {
      const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
      title.textContent = `Comandos de ${categoryName}`;
    }
  }
  
  // Mostrar mensaje si no hay comandos o regenerar la lista
  if (filteredCommands.length === 0) {
    const categoryName = category === 'all' ? 'todas las categor칤as' : `la categor칤a "${category}"`;
    container.innerHTML = `
      <div class="text-center py-12">
        <div class="text-gray-400 dark:text-gray-500 text-6xl mb-4">游댌</div>
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">
          No se encontraron comandos
        </h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          No hay comandos en ${categoryName}
        </p>
        <button 
          onclick="filterCommandsByCategory('all')" 
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
        >
          Ver todos los comandos
        </button>
      </div>
    `;
  } else {
    // Regenerar la lista de comandos
    const htmlContent = filteredCommands.map((command: any) => {
      // Generar el slug del comando
      const slug = command.title.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
      
      return `
        <div class="command-card cursor-pointer transition-transform hover:scale-[1.02] active:scale-[0.98]" onclick="showPreview('${command.title}')">
          <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow hover:shadow-lg transition-shadow border border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-3">
              <div class="flex-1 min-w-0">
                <h3 class="text-lg sm:text-xl font-mono font-semibold text-${getCategoryColor(command.category)}-700 dark:text-${getCategoryColor(command.category)}-400 truncate">
                  ${command.title}
                </h3>
              </div>
              ${command.dangerous ? `
                <span class="bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 text-xs font-bold px-2 py-1 rounded-full flex-shrink-0">丘멆잺</span>
              ` : ''}
              <a 
                href="/${slug}"
                onclick="event.stopPropagation()"
                class="flex-shrink-0 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors p-2 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg"
                title="Ver p치gina completa"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
              </a>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = htmlContent;
  }
}

// Funci칩n para obtener el color de categor칤a
function getCategoryColor(category: string): string {
  const colorMap: { [key: string]: string } = {
    'dns': 'blue',
    'linux': 'green',
    'security': 'red',
    'network': 'indigo',
    'database': 'purple',
    'web': 'orange',
    'git': 'teal',
    'docker': 'cyan',
    'scan': 'blue',
    'escan': 'blue',
    'python': 'green'
  };
  
  return colorMap[category.toLowerCase()] || 'gray';
}

// Escuchar eventos de cambio de categor칤a
window.addEventListener('categoryChanged', (event: any) => {
  filterCommandsByCategory(event.detail.category);
});

// Escuchar resultados de b칰squeda
window.addEventListener('searchResults', (event: any) => {
  const { results } = event.detail;
  displaySearchResults(results);
});

// Escuchar cuando se limpia la b칰squeda
window.addEventListener('searchCleared', () => {
  // Restaurar vista de categor칤a actual
  const activeCategory = document.querySelector('.category-btn.active');
  if (activeCategory) {
    const categoryId = activeCategory.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
    if (categoryId) {
      filterCommandsByCategory(categoryId);
    }
  } else {
    // Si no hay categor칤a activa, mostrar todos
    filterCommandsByCategory('all');
  }
});

// Funci칩n para mostrar resultados de b칰squeda
function displaySearchResults(results: any[]) {
  const container = document.getElementById('desktop-command-list-container');
  if (!container) return;
  
  // Actualizar contador
  const counter = document.getElementById('command-count');
  if (counter) {
    counter.textContent = results.length.toString();
  }
  
  // Actualizar t칤tulo
  const title = document.querySelector('main h2');
  if (title) {
    title.textContent = `Resultados de b칰squeda (${results.length})`;
  }
  
  if (results.length === 0) {
    container.innerHTML = `
      <div class="text-center py-12">
        <div class="text-gray-400 dark:text-gray-500 text-6xl mb-4">游댌</div>
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">
          No se encontraron resultados
        </h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Intenta con otros t칠rminos de b칰squeda
        </p>
        <button 
          onclick="clearSearch()" 
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
        >
          Limpiar b칰squeda
        </button>
      </div>
    `;
  } else {
    // Mostrar resultados de b칰squeda
    const htmlContent = results.map((command: any) => {
      // Generar el slug del comando
      const slug = command.title.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
      
      return `
        <div class="command-card cursor-pointer transition-transform hover:scale-[1.02] active:scale-[0.98]" onclick="showPreview('${command.title}')">
          <div class="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow hover:shadow-lg transition-shadow border border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-3">
              <div class="flex-1 min-w-0">
                <h3 class="text-lg sm:text-xl font-mono font-semibold text-${getCategoryColor(command.category)}-700 dark:text-${getCategoryColor(command.category)}-400 truncate">
                  ${command.title}
                </h3>
              </div>
              ${command.dangerous ? `
                <span class="bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 text-xs font-bold px-2 py-1 rounded-full flex-shrink-0">丘멆잺</span>
              ` : ''}
              <a 
                href="/${slug}"
                onclick="event.stopPropagation()"
                class="flex-shrink-0 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors p-2 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg"
                title="Ver p치gina completa"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
              </a>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = htmlContent;
  }
}

// Declarar globalmente
(window as any).showPreview = showPreview;
(window as any).filterCommandsByCategory = filterCommandsByCategory;
</script>
